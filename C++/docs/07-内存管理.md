# å†…å­˜ç®¡ç†

å†…å­˜ç®¡ç†æ˜¯ C++ çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ç†è§£æŒ‡é’ˆã€å¼•ç”¨ã€å†…å­˜åˆ†é…å’Œæ™ºèƒ½æŒ‡é’ˆå¯¹äºç¼–å†™é«˜æ•ˆã€å®‰å…¨çš„ C++ ç¨‹åºè‡³å…³é‡è¦ã€‚

## æŒ‡é’ˆ

### åŸºæœ¬æŒ‡é’ˆ

```cpp
#include <iostream>

int main() {
    int x = 42;
    
    // æŒ‡é’ˆå£°æ˜å’Œåˆå§‹åŒ–
    int* ptr = &x;  // ptr æŒ‡å‘ x çš„åœ°å€
    
    std::cout << "x = " << x << std::endl;           // 42
    std::cout << "&x = " << &x << std::endl;         // x çš„åœ°å€
    std::cout << "ptr = " << ptr << std::endl;       // x çš„åœ°å€
    std::cout << "*ptr = " << *ptr << std::endl;     // 42ï¼ˆè§£å¼•ç”¨ï¼‰
    
    // é€šè¿‡æŒ‡é’ˆä¿®æ”¹å€¼
    *ptr = 100;
    std::cout << "x = " << x << std::endl;            // 100
    
    // ç©ºæŒ‡é’ˆ
    int* null_ptr = nullptr;  // C++11ï¼ˆæ¨èï¼‰
    // int* null_ptr = NULL;   // C é£æ ¼ï¼ˆä¸æ¨èï¼‰
    // int* null_ptr = 0;       // æ—§æ–¹å¼ï¼ˆä¸æ¨èï¼‰
    
    // æ£€æŸ¥ç©ºæŒ‡é’ˆ
    if (ptr != nullptr) {
        std::cout << "ptr is not null" << std::endl;
    }
    
    return 0;
}
```

### æŒ‡é’ˆè¿ç®—

```cpp
#include <iostream>

int main() {
    int arr[] = {10, 20, 30, 40, 50};
    int* ptr = arr;  // æŒ‡å‘æ•°ç»„é¦–å…ƒç´ 
    
    // æŒ‡é’ˆç®—æœ¯
    std::cout << "*ptr = " << *ptr << std::endl;        // 10
    std::cout << "*(ptr + 1) = " << *(ptr + 1) << std::endl;  // 20
    std::cout << "*(ptr + 2) = " << *(ptr + 2) << std::endl;  // 30
    
    // æŒ‡é’ˆé€’å¢
    ptr++;
    std::cout << "*ptr = " << *ptr << std::endl;        // 20
    
    // æŒ‡é’ˆæ¯”è¾ƒ
    int* ptr2 = arr + 3;
    if (ptr < ptr2) {
        std::cout << "ptr is before ptr2" << std::endl;
    }
    
    // æŒ‡é’ˆå·®å€¼
    std::ptrdiff_t diff = ptr2 - ptr;
    std::cout << "Difference: " << diff << std::endl;    // 2
    
    return 0;
}
```

### æŒ‡é’ˆå’Œæ•°ç»„

```cpp
#include <iostream>

int main() {
    int arr[5] = {1, 2, 3, 4, 5};
    
    // æ•°ç»„åæ˜¯æŒ‡å‘é¦–å…ƒç´ çš„æŒ‡é’ˆ
    int* ptr = arr;  // ç­‰ä»·äº int* ptr = &arr[0];
    
    // ä½¿ç”¨æŒ‡é’ˆéå†æ•°ç»„
    for (int i = 0; i < 5; ++i) {
        std::cout << ptr[i] << " ";  // ä½¿ç”¨ä¸‹æ ‡
    }
    std::cout << std::endl;
    
    // ä½¿ç”¨æŒ‡é’ˆç®—æœ¯
    for (int* p = arr; p < arr + 5; ++p) {
        std::cout << *p << " ";
    }
    std::cout << std::endl;
    
    return 0;
}
```

### æŒ‡é’ˆå’Œå‡½æ•°

```cpp
#include <iostream>

// æŒ‡é’ˆä½œä¸ºå‚æ•°
void increment(int* x) {
    (*x)++;  // è§£å¼•ç”¨å¹¶ä¿®æ”¹
}

// æŒ‡é’ˆä½œä¸ºè¿”å›å€¼
int* find_max(int* arr, size_t size) {
    if (size == 0) return nullptr;
    
    int* max_ptr = arr;
    for (size_t i = 1; i < size; ++i) {
        if (arr[i] > *max_ptr) {
            max_ptr = &arr[i];
        }
    }
    return max_ptr;
}

int main() {
    int value = 10;
    increment(&value);
    std::cout << "value = " << value << std::endl;  // 11
    
    int arr[] = {3, 1, 4, 1, 5};
    int* max = find_max(arr, 5);
    if (max != nullptr) {
        std::cout << "Max value: " << *max << std::endl;
    }
    
    return 0;
}
```

## å¼•ç”¨

### åŸºæœ¬å¼•ç”¨

```cpp
#include <iostream>

int main() {
    int x = 42;
    
    // å¼•ç”¨å£°æ˜å’Œåˆå§‹åŒ–
    int& ref = x;  // ref æ˜¯ x çš„åˆ«å
    
    std::cout << "x = " << x << std::endl;        // 42
    std::cout << "ref = " << ref << std::endl;     // 42
    std::cout << "&x = " << &x << std::endl;      // åœ°å€
    std::cout << "&ref = " << &ref << std::endl;  // ç›¸åŒåœ°å€
    
    // é€šè¿‡å¼•ç”¨ä¿®æ”¹å€¼
    ref = 100;
    std::cout << "x = " << x << std::endl;        // 100
    
    // å¼•ç”¨å¿…é¡»åˆå§‹åŒ–
    // int& ref2;  // é”™è¯¯ï¼
    
    // å¼•ç”¨ä¸èƒ½é‡æ–°ç»‘å®š
    int y = 200;
    // ref = y;  // è¿™æ˜¯èµ‹å€¼ï¼Œä¸æ˜¯é‡æ–°ç»‘å®š
    
    return 0;
}
```

### å¼•ç”¨ä½œä¸ºå‡½æ•°å‚æ•°

```cpp
#include <iostream>
#include <string>

// å¼•ç”¨å‚æ•°ï¼šé¿å…å¤åˆ¶ï¼Œå¯ä»¥ä¿®æ”¹
void swap(int& a, int& b) {
    int temp = a;
    a = b;
    b = temp;
}

// å¸¸é‡å¼•ç”¨ï¼šé¿å…å¤åˆ¶ï¼Œåªè¯»
void print_string(const std::string& str) {
    std::cout << str << std::endl;
    // str = "new";  // é”™è¯¯ï¼ä¸èƒ½ä¿®æ”¹å¸¸é‡å¼•ç”¨
}

int main() {
    int x = 10, y = 20;
    swap(x, y);
    std::cout << "x = " << x << ", y = " << y << std::endl;  // x = 20, y = 10
    
    std::string msg = "Hello";
    print_string(msg);
    
    return 0;
}
```

### å¼•ç”¨ä½œä¸ºè¿”å›å€¼

```cpp
#include <iostream>
#include <vector>

// è¿”å›å¼•ç”¨ï¼ˆé¿å…å¤åˆ¶ï¼‰
int& get_element(std::vector<int>& vec, size_t index) {
    return vec[index];
}

// è¿”å›å¸¸é‡å¼•ç”¨
const std::string& get_name() {
    static std::string name = "Alice";  // é™æ€å˜é‡ï¼Œç”Ÿå‘½å‘¨æœŸå»¶é•¿
    return name;
}

int main() {
    std::vector<int> vec = {10, 20, 30, 40, 50};
    
    // é€šè¿‡å¼•ç”¨ä¿®æ”¹å…ƒç´ 
    get_element(vec, 2) = 100;
    std::cout << vec[2] << std::endl;  // 100
    
    const std::string& name = get_name();
    std::cout << name << std::endl;
    
    return 0;
}
```

### æŒ‡é’ˆ vs å¼•ç”¨

| ç‰¹æ€§ | æŒ‡é’ˆ | å¼•ç”¨ |
|------|------|------|
| **å£°æ˜** | `int* ptr` | `int& ref` |
| **åˆå§‹åŒ–** | å¯ä»¥å»¶è¿Ÿåˆå§‹åŒ– | å¿…é¡»ç«‹å³åˆå§‹åŒ– |
| **é‡æ–°ç»‘å®š** | å¯ä»¥æŒ‡å‘å…¶ä»–å¯¹è±¡ | ä¸èƒ½é‡æ–°ç»‘å®š |
| **ç©ºå€¼** | å¯ä»¥ä¸º `nullptr` | ä¸èƒ½ä¸ºç©º |
| **è§£å¼•ç”¨** | éœ€è¦ `*ptr` | ç›´æ¥ä½¿ç”¨ `ref` |
| **åœ°å€** | æœ‰è‡ªå·±çš„åœ°å€ | ä¸è¢«å¼•ç”¨å¯¹è±¡åŒåœ°å€ |
| **æ•°ç»„** | å¯ä»¥æŒ‡å‘æ•°ç»„ | ä¸èƒ½æŒ‡å‘æ•°ç»„ |

## åŠ¨æ€å†…å­˜åˆ†é…

### new å’Œ delete

```cpp
#include <iostream>

int main() {
    // åˆ†é…å•ä¸ªå¯¹è±¡
    int* ptr = new int(42);
    std::cout << "*ptr = " << *ptr << std::endl;
    delete ptr;  // é‡Šæ”¾å†…å­˜
    ptr = nullptr;  // é¿å…æ‚¬ç©ºæŒ‡é’ˆ
    
    // åˆ†é…æ•°ç»„
    int* arr = new int[5]{1, 2, 3, 4, 5};
    for (int i = 0; i < 5; ++i) {
        std::cout << arr[i] << " ";
    }
    std::cout << std::endl;
    delete[] arr;  // é‡Šæ”¾æ•°ç»„
    arr = nullptr;
    
    // åˆ†é…å¯¹è±¡
    class MyClass {
    public:
        MyClass(int x) : value(x) {
            std::cout << "Constructor: " << value << std::endl;
        }
        ~MyClass() {
            std::cout << "Destructor: " << value << std::endl;
        }
    private:
        int value;
    };
    
    MyClass* obj = new MyClass(100);
    delete obj;
    
    return 0;
}
```

### å¸¸è§é”™è¯¯

```cpp
#include <iostream>

// é”™è¯¯ 1ï¼šå†…å­˜æ³„æ¼
void memory_leak() {
    int* ptr = new int(42);
    // å¿˜è®° deleteï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
}

// é”™è¯¯ 2ï¼šé‡å¤é‡Šæ”¾
void double_delete() {
    int* ptr = new int(42);
    delete ptr;
    delete ptr;  // é”™è¯¯ï¼é‡å¤é‡Šæ”¾
}

// é”™è¯¯ 3ï¼šä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜
void use_after_free() {
    int* ptr = new int(42);
    delete ptr;
    *ptr = 100;  // é”™è¯¯ï¼ä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜
}

// é”™è¯¯ 4ï¼šæ•°ç»„å’Œå•ä¸ªå¯¹è±¡æ··ç”¨
void wrong_delete() {
    int* arr = new int[5];
    delete arr;  // é”™è¯¯ï¼åº”è¯¥ä½¿ç”¨ delete[]
    
    int* ptr = new int(42);
    delete[] ptr;  // é”™è¯¯ï¼åº”è¯¥ä½¿ç”¨ delete
}
```

## æ™ºèƒ½æŒ‡é’ˆï¼ˆC++11ï¼‰

### std::unique_ptr

```cpp
#include <iostream>
#include <memory>

int main() {
    // unique_ptrï¼šç‹¬å æ‰€æœ‰æƒ
    std::unique_ptr<int> ptr1 = std::make_unique<int>(42);
    std::cout << "*ptr1 = " << *ptr1 << std::endl;
    
    // è‡ªåŠ¨é‡Šæ”¾å†…å­˜
    {
        std::unique_ptr<int> ptr2 = std::make_unique<int>(100);
        std::cout << "*ptr2 = " << *ptr2 << std::endl;
    }  // ptr2 è‡ªåŠ¨é‡Šæ”¾
    
    // ä¸èƒ½å¤åˆ¶ï¼Œåªèƒ½ç§»åŠ¨
    std::unique_ptr<int> ptr3 = std::move(ptr1);
    // std::cout << *ptr1 << std::endl;  // é”™è¯¯ï¼ptr1 å·²ç§»åŠ¨
    
    // æ•°ç»„ç‰ˆæœ¬
    std::unique_ptr<int[]> arr = std::make_unique<int[]>(5);
    arr[0] = 10;
    arr[1] = 20;
    
    // è‡ªå®šä¹‰åˆ é™¤å™¨
    auto deleter = [](int* p) {
        std::cout << "Custom deleter" << std::endl;
        delete p;
    };
    std::unique_ptr<int, decltype(deleter)> ptr4(new int(200), deleter);
    
    return 0;
}
```

### std::shared_ptr

```cpp
#include <iostream>
#include <memory>

int main() {
    // shared_ptrï¼šå…±äº«æ‰€æœ‰æƒï¼ˆå¼•ç”¨è®¡æ•°ï¼‰
    std::shared_ptr<int> ptr1 = std::make_shared<int>(42);
    std::cout << "ptr1 use_count: " << ptr1.use_count() << std::endl;  // 1
    
    {
        std::shared_ptr<int> ptr2 = ptr1;  // å…±äº«æ‰€æœ‰æƒ
        std::cout << "ptr1 use_count: " << ptr1.use_count() << std::endl;  // 2
        std::cout << "ptr2 use_count: " << ptr2.use_count() << std::endl;  // 2
    }  // ptr2 ç¦»å¼€ä½œç”¨åŸŸï¼Œå¼•ç”¨è®¡æ•°å‡ 1
    
    std::cout << "ptr1 use_count: " << ptr1.use_count() << std::endl;  // 1
    
    // æ£€æŸ¥æ˜¯å¦å”¯ä¸€
    if (ptr1.unique()) {
        std::cout << "ptr1 is unique" << std::endl;
    }
    
    // é‡ç½®
    ptr1.reset();
    if (ptr1 == nullptr) {
        std::cout << "ptr1 is null" << std::endl;
    }
    
    return 0;
}
```

### std::weak_ptr

```cpp
#include <iostream>
#include <memory>

int main() {
    // weak_ptrï¼šä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œé¿å…å¾ªç¯å¼•ç”¨
    std::shared_ptr<int> shared = std::make_shared<int>(42);
    std::weak_ptr<int> weak = shared;
    
    std::cout << "shared use_count: " << shared.use_count() << std::endl;  // 1
    
    // æ£€æŸ¥ weak_ptr æ˜¯å¦æœ‰æ•ˆ
    if (auto locked = weak.lock()) {
        std::cout << "Value: " << *locked << std::endl;
    }
    
    // é‡Šæ”¾ shared_ptr
    shared.reset();
    
    // weak_ptr å¤±æ•ˆ
    if (weak.expired()) {
        std::cout << "weak_ptr is expired" << std::endl;
    }
    
    return 0;
}
```

### æ™ºèƒ½æŒ‡é’ˆå¯¹æ¯”

| ç‰¹æ€§ | unique_ptr | shared_ptr | weak_ptr |
|------|-----------|-----------|----------|
| **æ‰€æœ‰æƒ** | ç‹¬å  | å…±äº« | æ— æ‰€æœ‰æƒ |
| **å¤åˆ¶** | âŒ | âœ… | âœ… |
| **ç§»åŠ¨** | âœ… | âœ… | âœ… |
| **å¼•ç”¨è®¡æ•°** | æ—  | æœ‰ | ä¸å¢åŠ è®¡æ•° |
| **æ€§èƒ½** | æœ€å¿« | è¾ƒæ…¢ | è¾ƒæ…¢ |
| **é€‚ç”¨åœºæ™¯** | å•ä¸€æ‰€æœ‰è€… | å¤šä¸ªæ‰€æœ‰è€… | æ‰“ç ´å¾ªç¯å¼•ç”¨ |

## å†…å­˜ç®¡ç†æœ€ä½³å®è·µ

### 1. ä¼˜å…ˆä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ

```cpp
#include <memory>

// ä¸æ¨èï¼šæ‰‹åŠ¨ç®¡ç†
void bad_example() {
    int* ptr = new int(42);
    // ... ä½¿ç”¨ ptr
    delete ptr;  // å®¹æ˜“å¿˜è®°
}

// æ¨èï¼šä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ
void good_example() {
    auto ptr = std::make_unique<int>(42);
    // ... ä½¿ç”¨ ptr
    // è‡ªåŠ¨é‡Šæ”¾ï¼Œæ— éœ€æ‰‹åŠ¨ delete
}
```

### 2. ä½¿ç”¨ RAIIï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰

```cpp
#include <iostream>
#include <memory>

class Resource {
private:
    int* data;
    size_t size;

public:
    Resource(size_t s) : size(s) {
        data = new int[size];
        std::cout << "Resource acquired" << std::endl;
    }
    
    ~Resource() {
        delete[] data;
        std::cout << "Resource released" << std::endl;
    }
    
    // ç¦ç”¨å¤åˆ¶
    Resource(const Resource&) = delete;
    Resource& operator=(const Resource&) = delete;
    
    // å…è®¸ç§»åŠ¨
    Resource(Resource&& other) noexcept 
        : data(other.data), size(other.size) {
        other.data = nullptr;
        other.size = 0;
    }
};

int main() {
    {
        Resource res(100);
        // res ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾èµ„æº
    }
    
    return 0;
}
```

### 3. é¿å…åŸå§‹æŒ‡é’ˆçš„æ‰€æœ‰æƒè¯­ä¹‰

```cpp
#include <memory>

// ä¸æ¨èï¼šåŸå§‹æŒ‡é’ˆä¼ é€’æ‰€æœ‰æƒ
void transfer_ownership(int* ptr) {
    // è°è´Ÿè´£é‡Šæ”¾ï¼Ÿ
    delete ptr;
}

// æ¨èï¼šä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆæ˜ç¡®æ‰€æœ‰æƒ
void transfer_ownership(std::unique_ptr<int> ptr) {
    // æ‰€æœ‰æƒæ˜ç¡®ï¼Œè‡ªåŠ¨é‡Šæ”¾
}
```

## å®è·µç»ƒä¹ 

### ç»ƒä¹  1ï¼šå®ç°ç®€å•çš„æ™ºèƒ½æŒ‡é’ˆ

```cpp
#include <iostream>

template<typename T>
class SimpleUniquePtr {
private:
    T* ptr;

public:
    explicit SimpleUniquePtr(T* p = nullptr) : ptr(p) {}
    
    ~SimpleUniquePtr() {
        delete ptr;
    }
    
    // ç¦ç”¨å¤åˆ¶
    SimpleUniquePtr(const SimpleUniquePtr&) = delete;
    SimpleUniquePtr& operator=(const SimpleUniquePtr&) = delete;
    
    // å…è®¸ç§»åŠ¨
    SimpleUniquePtr(SimpleUniquePtr&& other) noexcept : ptr(other.ptr) {
        other.ptr = nullptr;
    }
    
    T& operator*() const { return *ptr; }
    T* operator->() const { return ptr; }
    T* get() const { return ptr; }
    
    explicit operator bool() const {
        return ptr != nullptr;
    }
};

int main() {
    SimpleUniquePtr<int> ptr(new int(42));
    std::cout << *ptr << std::endl;
    
    return 0;
}
```

## ä¸å…¶ä»–è¯­è¨€å¯¹æ¯”

| ç‰¹æ€§ | C++ | Java | Python | Go | Rust |
|------|-----|------|--------|-----|------|
| **å†…å­˜ç®¡ç†** | æ‰‹åŠ¨/æ™ºèƒ½æŒ‡é’ˆ | GC | GC | GC | æ‰€æœ‰æƒç³»ç»Ÿ |
| **æŒ‡é’ˆ** | âœ… | âŒ | âŒ | âŒ | âœ…ï¼ˆå—é™ï¼‰ |
| **å¼•ç”¨** | âœ… | âŒ | âŒ | âŒ | âœ…ï¼ˆå€Ÿç”¨ï¼‰ |
| **æ™ºèƒ½æŒ‡é’ˆ** | âœ… (C++11) | âŒ | âŒ | âŒ | âœ… |
| **å†…å­˜å®‰å…¨** | éœ€æ³¨æ„ | è‡ªåŠ¨ | è‡ªåŠ¨ | è‡ªåŠ¨ | ç¼–è¯‘æ—¶ä¿è¯ |

## ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»æŒæ¡äº†å†…å­˜ç®¡ç†ï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

1. **[æ¨¡æ¿ç¼–ç¨‹](./08-æ¨¡æ¿ç¼–ç¨‹.md)** - å­¦ä¹ æ³›å‹ç¼–ç¨‹
2. **[STL æ ‡å‡†åº“](./09-STLæ ‡å‡†åº“.md)** - æŒæ¡æ ‡å‡†åº“çš„ä½¿ç”¨
3. **[å¼‚å¸¸å¤„ç†](./10-å¼‚å¸¸å¤„ç†.md)** - å­¦ä¹ é”™è¯¯å¤„ç†

ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼ğŸ‰

