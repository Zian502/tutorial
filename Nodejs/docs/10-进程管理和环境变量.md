# 进程管理和环境变量

## process 对象

`process` 对象是 Node.js 的全局对象，提供了与当前 Node.js 进程交互的接口。

### 与其他语言的对比

| 特性 | Node.js process | Python sys/os | Java System/Runtime | Go os |
|------|----------------|---------------|---------------------|-------|
| 环境变量 | process.env | os.environ | System.getenv() | os.Getenv() |
| 命令行参数 | process.argv | sys.argv | main(String[] args) | os.Args |
| 退出码 | process.exit() | sys.exit() | System.exit() | os.Exit() |
| 工作目录 | process.cwd() | os.getcwd() | System.getProperty() | os.Getwd() |

## 进程信息

### 基本信息

```javascript
// 进程 ID
console.log('进程 ID:', process.pid);

// 父进程 ID
console.log('父进程 ID:', process.ppid);

// Node.js 版本
console.log('Node.js 版本:', process.version);
console.log('V8 版本:', process.versions.v8);

// 平台信息
console.log('平台:', process.platform);  // 'darwin', 'linux', 'win32'
console.log('架构:', process.arch);       // 'x64', 'arm64'

// 运行时间
console.log('运行时间:', process.uptime(), '秒');

// 内存使用
const usage = process.memoryUsage();
console.log('内存使用:', {
  rss: `${Math.round(usage.rss / 1024 / 1024)} MB`,      // 常驻集大小
  heapTotal: `${Math.round(usage.heapTotal / 1024 / 1024)} MB`,
  heapUsed: `${Math.round(usage.heapUsed / 1024 / 1024)} MB`,
  external: `${Math.round(usage.external / 1024 / 1024)} MB`
});

// CPU 使用情况
const cpuUsage = process.cpuUsage();
console.log('CPU 使用:', {
  用户时间: `${cpuUsage.user / 1000} 微秒`,
  系统时间: `${cpuUsage.system / 1000} 微秒`
});
```

### 工作目录

```javascript
// 获取当前工作目录
console.log('当前工作目录:', process.cwd());

// 更改工作目录
process.chdir('/tmp');
console.log('新工作目录:', process.cwd());

// 使用 path 模块处理路径
const path = require('path');
const projectRoot = path.resolve(__dirname, '..');
process.chdir(projectRoot);
```

**与其他语言对比**：
- **Python**: `os.getcwd()`, `os.chdir()`
- **Java**: `System.getProperty("user.dir")`
- **Go**: `os.Getwd()`, `os.Chdir()`

## 命令行参数

### 解析命令行参数

```javascript
// process.argv 包含命令行参数
// [0] = node 可执行文件路径
// [1] = 脚本文件路径
// [2+] = 命令行参数

console.log('所有参数:', process.argv);

// 解析参数
function parseArgs() {
  const args = process.argv.slice(2);
  const options = {};
  
  for (let i = 0; i < args.length; i++) {
    const arg = args[i];
    
    if (arg.startsWith('--')) {
      const key = arg.slice(2);
      const value = args[i + 1] && !args[i + 1].startsWith('--')
        ? args[++i]
        : true;
      options[key] = value;
    } else if (arg.startsWith('-')) {
      const key = arg.slice(1);
      options[key] = true;
    }
  }
  
  return options;
}

// 使用
// node app.js --port 3000 --debug
const options = parseArgs();
console.log('选项:', options);
// { port: '3000', debug: true }
```

### 使用第三方库

```javascript
// 使用 commander.js
const { Command } = require('commander');

const program = new Command();

program
  .option('-p, --port <port>', '端口号', '3000')
  .option('-d, --debug', '调试模式')
  .parse(process.argv);

const options = program.opts();
console.log('端口:', options.port);
console.log('调试:', options.debug);
```

## 环境变量

### 读取环境变量

```javascript
// 读取环境变量
console.log('NODE_ENV:', process.env.NODE_ENV);
console.log('PATH:', process.env.PATH);

// 设置环境变量（仅当前进程）
process.env.MY_VAR = 'my-value';
console.log('MY_VAR:', process.env.MY_VAR);

// 检查环境变量是否存在
if (process.env.NODE_ENV === 'production') {
  console.log('生产环境');
} else {
  console.log('开发环境');
}
```

### 加载 .env 文件

```javascript
// 使用 dotenv 包
require('dotenv').config();

// 现在可以访问 .env 文件中的变量
console.log('数据库 URL:', process.env.DATABASE_URL);
console.log('API 密钥:', process.env.API_KEY);
```

### 环境变量最佳实践

```javascript
// 配置管理
class Config {
  constructor() {
    this.nodeEnv = process.env.NODE_ENV || 'development';
    this.port = parseInt(process.env.PORT || '3000', 10);
    this.dbUrl = process.env.DATABASE_URL || 'mongodb://localhost:27017/mydb';
    this.apiKey = process.env.API_KEY;
    
    if (!this.apiKey) {
      throw new Error('API_KEY 环境变量未设置');
    }
  }
  
  isDevelopment() {
    return this.nodeEnv === 'development';
  }
  
  isProduction() {
    return this.nodeEnv === 'production';
  }
}

const config = new Config();
console.log('配置:', config);
```

**与其他语言对比**：
- **Python**: `os.environ.get('KEY')` 或 `os.getenv('KEY')`
- **Java**: `System.getenv("KEY")`
- **Go**: `os.Getenv("KEY")`

## 进程退出

### 正常退出

```javascript
// 退出进程
process.exit(0);  // 成功退出
process.exit(1);  // 错误退出

// 退出前执行清理
process.on('exit', (code) => {
  console.log(`进程退出，退出码: ${code}`);
  // 执行清理操作
});

// 立即退出（不执行清理）
process.exit(1);
```

### 优雅退出

```javascript
// 捕获退出信号
process.on('SIGTERM', () => {
  console.log('收到 SIGTERM 信号');
  gracefulShutdown();
});

process.on('SIGINT', () => {
  console.log('收到 SIGINT 信号 (Ctrl+C)');
  gracefulShutdown();
});

function gracefulShutdown() {
  // 停止接受新请求
  server.close(() => {
    console.log('HTTP 服务器已关闭');
    
    // 关闭数据库连接
    db.close(() => {
      console.log('数据库连接已关闭');
      process.exit(0);
    });
  });
  
  // 强制退出超时
  setTimeout(() => {
    console.error('强制退出');
    process.exit(1);
  }, 10000);
}
```

## 信号处理

### 常见信号

```javascript
// SIGTERM - 终止信号（可捕获）
process.on('SIGTERM', () => {
  console.log('收到 SIGTERM');
  process.exit(0);
});

// SIGINT - 中断信号（Ctrl+C）
process.on('SIGINT', () => {
  console.log('收到 SIGINT');
  process.exit(0);
});

// SIGHUP - 挂起信号
process.on('SIGHUP', () => {
  console.log('收到 SIGHUP');
  // 重新加载配置
  reloadConfig();
});

// SIGUSR1 - 用户定义信号 1
process.on('SIGUSR1', () => {
  console.log('收到 SIGUSR1');
  // 打开调试器
});

// SIGUSR2 - 用户定义信号 2
process.on('SIGUSR2', () => {
  console.log('收到 SIGUSR2');
  // 零停机重启
});
```

### 发送信号

```javascript
// 向其他进程发送信号
process.kill(process.pid, 'SIGTERM');

// 向子进程发送信号
const { spawn } = require('child_process');
const child = spawn('node', ['child.js']);

// 发送信号
child.kill('SIGTERM');
```

## 标准输入输出

### 标准输入

```javascript
// 读取标准输入
process.stdin.setEncoding('utf8');

process.stdin.on('data', (chunk) => {
  const input = chunk.trim();
  console.log('输入:', input);
  
  if (input === 'exit') {
    process.exit(0);
  }
});

// 或使用 readline 模块
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

rl.question('请输入你的名字: ', (answer) => {
  console.log(`你好, ${answer}!`);
  rl.close();
});
```

### 标准输出

```javascript
// 写入标准输出
process.stdout.write('Hello, World!\n');

// 使用 console（内部使用 process.stdout）
console.log('日志信息');
console.error('错误信息');
console.warn('警告信息');
```

### 重定向

```bash
# 重定向标准输出
node app.js > output.txt

# 重定向标准错误
node app.js 2> error.txt

# 重定向标准输入
node app.js < input.txt

# 同时重定向
node app.js > output.txt 2>&1
```

## 实际应用场景

### 场景 1：配置管理

```javascript
class AppConfig {
  constructor() {
    // 从环境变量读取配置
    this.env = process.env.NODE_ENV || 'development';
    this.port = parseInt(process.env.PORT || '3000', 10);
    this.host = process.env.HOST || 'localhost';
    
    // 数据库配置
    this.db = {
      host: process.env.DB_HOST || 'localhost',
      port: parseInt(process.env.DB_PORT || '5432', 10),
      name: process.env.DB_NAME || 'mydb',
      user: process.env.DB_USER || 'user',
      password: process.env.DB_PASSWORD || 'password'
    };
    
    // API 配置
    this.api = {
      key: process.env.API_KEY,
      timeout: parseInt(process.env.API_TIMEOUT || '5000', 10)
    };
    
    // 验证必需配置
    this.validate();
  }
  
  validate() {
    const required = ['API_KEY'];
    const missing = required.filter(key => !process.env[key]);
    
    if (missing.length > 0) {
      throw new Error(`缺少必需的环境变量: ${missing.join(', ')}`);
    }
  }
  
  isDevelopment() {
    return this.env === 'development';
  }
  
  isProduction() {
    return this.env === 'production';
  }
}

const config = new AppConfig();
console.log('应用配置:', config);
```

### 场景 2：优雅关闭服务器

```javascript
const http = require('http');

const server = http.createServer((req, res) => {
  res.writeHead(200);
  res.end('OK\n');
});

server.listen(3000, () => {
  console.log('服务器运行在 http://localhost:3000');
});

// 优雅关闭
let isShuttingDown = false;

function gracefulShutdown(signal) {
  if (isShuttingDown) {
    return;
  }
  
  isShuttingDown = true;
  console.log(`收到 ${signal}，开始优雅关闭...`);
  
  // 停止接受新连接
  server.close(() => {
    console.log('HTTP 服务器已关闭');
    
    // 关闭其他资源
    closeDatabase(() => {
      console.log('数据库已关闭');
      process.exit(0);
    });
  });
  
  // 强制退出超时
  setTimeout(() => {
    console.error('强制退出');
    process.exit(1);
  }, 10000);
}

process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));

function closeDatabase(callback) {
  // 关闭数据库连接
  setTimeout(callback, 1000);
}
```

### 场景 3：健康检查

```javascript
const http = require('http');

class HealthChecker {
  constructor() {
    this.startTime = Date.now();
    this.checks = {
      uptime: () => Date.now() - this.startTime,
      memory: () => process.memoryUsage(),
      cpu: () => process.cpuUsage()
    };
  }
  
  check() {
    const health = {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: this.checks.uptime(),
      memory: this.checks.memory(),
      cpu: this.checks.cpu()
    };
    
    // 检查内存使用
    const memoryUsage = health.memory.heapUsed / health.memory.heapTotal;
    if (memoryUsage > 0.9) {
      health.status = 'unhealthy';
      health.message = '内存使用过高';
    }
    
    return health;
  }
}

const healthChecker = new HealthChecker();

const server = http.createServer((req, res) => {
  if (req.url === '/health') {
    const health = healthChecker.check();
    res.writeHead(health.status === 'healthy' ? 200 : 503, {
      'Content-Type': 'application/json'
    });
    res.end(JSON.stringify(health));
  } else {
    res.writeHead(404);
    res.end('Not Found');
  }
});

server.listen(3000);
```

### 场景 4：进程监控

```javascript
class ProcessMonitor {
  constructor(interval = 5000) {
    this.interval = interval;
    this.timer = null;
  }
  
  start() {
    this.timer = setInterval(() => {
      this.logMetrics();
    }, this.interval);
  }
  
  stop() {
    if (this.timer) {
      clearInterval(this.timer);
    }
  }
  
  logMetrics() {
    const usage = process.memoryUsage();
    const cpuUsage = process.cpuUsage();
    const uptime = process.uptime();
    
    console.log({
      timestamp: new Date().toISOString(),
      pid: process.pid,
      uptime: `${Math.round(uptime)}s`,
      memory: {
        rss: `${Math.round(usage.rss / 1024 / 1024)} MB`,
        heapUsed: `${Math.round(usage.heapUsed / 1024 / 1024)} MB`,
        heapTotal: `${Math.round(usage.heapTotal / 1024 / 1024)} MB`
      },
      cpu: {
        user: `${cpuUsage.user / 1000} ms`,
        system: `${cpuUsage.system / 1000} ms`
      }
    });
  }
}

// 使用
const monitor = new ProcessMonitor();
monitor.start();

// 停止监控
process.on('SIGINT', () => {
  monitor.stop();
  process.exit(0);
});
```

## 最佳实践

### 1. 使用环境变量管理配置

```javascript
// ✅ 正确：从环境变量读取配置
const config = {
  port: process.env.PORT || 3000,
  dbUrl: process.env.DATABASE_URL
};

// ❌ 错误：硬编码配置
const config = {
  port: 3000,
  dbUrl: 'mongodb://localhost:27017/mydb'
};
```

### 2. 验证必需的环境变量

```javascript
function validateEnv() {
  const required = ['DATABASE_URL', 'API_KEY', 'SECRET'];
  const missing = required.filter(key => !process.env[key]);
  
  if (missing.length > 0) {
    console.error('缺少必需的环境变量:', missing.join(', '));
    process.exit(1);
  }
}

validateEnv();
```

### 3. 优雅关闭

```javascript
// 始终实现优雅关闭
process.on('SIGTERM', gracefulShutdown);
process.on('SIGINT', gracefulShutdown);
```

### 4. 使用 .env 文件

```bash
# .env 文件
NODE_ENV=development
PORT=3000
DATABASE_URL=mongodb://localhost:27017/mydb
API_KEY=your-api-key
```

```javascript
// 加载 .env
require('dotenv').config();
```

## 总结

- **process 对象**提供进程信息和控制接口
- 使用**环境变量**管理配置，不要硬编码
- 实现**优雅关闭**处理 SIGTERM 和 SIGINT 信号
- 使用 **.env 文件**存储开发环境配置
- 验证**必需的环境变量**，启动时检查
- 监控**进程资源使用**（内存、CPU）
- 使用**健康检查端点**监控应用状态
- 正确处理**标准输入输出**和**信号**

